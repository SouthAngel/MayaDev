"""
	These classes are the UI builders for the options of import and Export
	of a render setup.
"""
import maya
maya.utils.loadStringResourcesForModule(__name__)


import maya.cmds as cmds

import maya.app.renderSetup.model.jsonTranslatorUtils as jsonTranslatorUtils
import maya.app.renderSetup.model.jsonTranslatorGlobals as jsonTranslatorGlobals
import maya.app.renderSetup.model.renderSetupPreferences as userPrefs


# Text to localize
kNotes                  = maya.stringTable['y_importExportUI.kNotes'   ]
kPreview                = maya.stringTable['y_importExportUI.kPreview' ]
kOverwrite              = maya.stringTable['y_importExportUI.kOverwrite' ]
kOverwriteExplanation   = maya.stringTable['y_importExportUI.kOverriteExplanation' ]
kMerge                  = maya.stringTable['y_importExportUI.kMerge' ]
kMergeExplanation       = maya.stringTable['y_importExportUI.kMergeExplanation' ]
kMergeAOVExplanation    = maya.stringTable['y_importExportUI.kMergeAOVExplanation' ]
kRename                 = maya.stringTable['y_importExportUI.kRename' ]
kRenameExplanation      = maya.stringTable['y_importExportUI.kRenameExplanation' ]
kTextToPrepend          = maya.stringTable['y_importExportUI.kTextToPrepend' ]
kDefaultTextToPrepend   = 'Import_'
kGeneralOptions         = maya.stringTable['y_importExportUI.kGeneralOptions' ]
kLabelColorOptions              = maya.stringTable['y_importExportUI.kLabelColorOptions' ]
kLabelColorImport              = maya.stringTable['y_importExportUI.kLabelColorImport' ]
kLabelColorImportExplanation   = maya.stringTable['y_importExportUI.kLabelColorImportExplanation' ]
kLabelColorExport              = maya.stringTable['y_importExportUI.kLabelColorExport' ]
kLabelColorExportExplanation   = maya.stringTable['y_importExportUI.kLabelColorExportExplanation' ]
kRenderSettingsOptions         = maya.stringTable['y_importExportUI.kRenderSettingsOptions' ]
kRenderSettingsExport          = maya.stringTable['y_importExportUI.kRenderSettingsExport' ]
kRenderSettingsExportExplanation = maya.stringTable['y_importExportUI.kRenderSettingExportExplanation' ]   

# List of all error messages
kUnknownFile = maya.stringTable['y_importExportUI.kUnknownFile' ]


class ParentGuard(object):
    def __enter__(self):
        pass

    def __exit__(self, type, value, traceback):
        cmds.setParent('..')

# Indentation used by the UI        
DEFAULT_UI_INDENTATION = 12



class ExportUI(object):
    """
        Helper class to build the Options UI for the fileDialog2 command used when exporting all
    """
    
    # Notes
    notesText = None
    notesTextEditor = None
    exportTextEditor = None
    exportColorType = jsonTranslatorGlobals.ACCEPT_COLOR

    @staticmethod
    def addOptions(parent, exportOption):
    # exportOption is 1 if user selected Export All else 0 for Export Selected
        with ParentGuard():
            cmds.setParent(parent)
            cmds.frameLayout(label=kGeneralOptions, collapsable=True, marginWidth=DEFAULT_UI_INDENTATION, marginHeight=DEFAULT_UI_INDENTATION)
            cmds.columnLayout(rowSpacing=10, adjustableColumn=True)
            if exportOption:
                cmds.checkBox(label=kRenderSettingsExport, onCommand=ExportUI.setRenderSettingsExport, offCommand=ExportUI.setRenderSettingsExport, value=userPrefs.ExportRenderSettingsAOVs.isEnabled())
                cmds.text(label=kRenderSettingsExportExplanation, align='left')
            cmds.checkBox(label=kLabelColorExport, onCommand=ExportUI.setLabelColorExport, offCommand=ExportUI.setLabelColorExport, value=True if ExportUI.exportColorType==jsonTranslatorGlobals.ACCEPT_COLOR else False)
            cmds.text(label=kLabelColorExportExplanation, align='left')
            cmds.text(label="", align='left')

        cmds.text(label=kNotes, align='left')
        ExportUI.notesTextEditor = \
            cmds.scrollField(text='' if not ExportUI.notesText else ExportUI.notesText,
                                numberOfLines=5, changeCommand=ExportUI.setNotesText, wordWrap=True)
        cmds.setParent("..")
        cmds.setParent("..")

    @staticmethod
    def setNotesText(data):
        """ 
            Preserve the notes because it's consumed after the UI is gone.
            Note: Trap the focus changed which is the only way to have the text for a scroll field.
        """
        ImportAllUI.importType = jsonTranslatorGlobals.DECODE_AND_RENAME
        ExportUI.notesText = cmds.scrollField(ExportUI.notesTextEditor, query=True, text=True)

    @staticmethod
    def setLabelColorExport(value):
        """ 
            User can decide to export label colors to json 
        """
        ExportUI.exportColorType = jsonTranslatorGlobals.ACCEPT_COLOR if value else jsonTranslatorGlobals.REJECT_COLOR
        jsonTranslatorGlobals.enableExportLabelColor(value)

    @staticmethod
    def setRenderSettingsExport(value):
        """ 
            User can decide to export Render Settings and AOVs to json 
        """
        userPrefs.ExportRenderSettingsAOVs.setOptionVar(value)
        userPrefs.ExportRenderSettingsAOVs.setToggled(True)

class ImportAllUI(object):
    """
        Helper class to build the Options UI for the fileDialog2 command used when importing all
    """
    
    # What kind of import ?
    importType = jsonTranslatorGlobals.DECODE_AND_ADD

    # What is the text to prepend ?
    importText = kDefaultTextToPrepend
    importTextEditor = None
    
    importColorType = jsonTranslatorGlobals.ACCEPT_COLOR

    # Read-Only editors
    notesEditor   = None   # The notes
    previewEditor = None   # The content preview

    @staticmethod
    def addOptions(parent):
        with ParentGuard():
            cmds.setParent(parent)
            cmds.frameLayout(label=kGeneralOptions, collapsable=True, marginWidth=DEFAULT_UI_INDENTATION)
            cmds.columnLayout(rowSpacing=10, adjustableColumn=True)
            cmds.radioCollection()
            cmds.radioButton(label=kOverwrite, 
                onCommand=ImportAllUI.setOverwriteImportType, select=True if ImportAllUI.importType==jsonTranslatorGlobals.DECODE_AND_ADD else False)
            cmds.text(label=kOverwriteExplanation, align='left')
            cmds.radioButton(label=kMerge, 
                onCommand=ImportAllUI.setMergeImportType, select=True if ImportAllUI.importType==jsonTranslatorGlobals.DECODE_AND_MERGE else False)
            cmds.text(label=kMergeExplanation, align='left')
            cmds.radioButton(label=kRename, 
                onCommand=ImportAllUI.setRenameImportType, select=True if ImportAllUI.importType==jsonTranslatorGlobals.DECODE_AND_RENAME else False)
            cmds.text(label=kRenameExplanation, align='left')
                        
            with ParentGuard():
                cmds.columnLayout(columnOffset=('left', DEFAULT_UI_INDENTATION))
                cmds.text(label=kTextToPrepend, align='left')
                ImportAllUI.importTextEditor = \
                    cmds.textField(text=ImportAllUI.importText,
                                    textChangedCommand=ImportAllUI.setImportText,
                                    enable= True if ImportAllUI.importType==jsonTranslatorGlobals.DECODE_AND_RENAME else False)

            cmds.checkBox(label=kLabelColorImport, 
                onCommand=ImportAllUI.setLabelColorImport, offCommand=ImportAllUI.setLabelColorImport, value=True if ImportAllUI.importColorType==jsonTranslatorGlobals.ACCEPT_COLOR else False)
            cmds.text(label=kLabelColorImportExplanation, align='left')
            cmds.text(label="", align='left')

        cmds.text(label=kNotes, align='left')
        ImportAllUI.notesEditor = cmds.scrollField(editable=False)
        cmds.text(label=kPreview, align='left')
        ImportAllUI.previewEditor = cmds.scrollField(editable=False)

        cmds.setParent("..")
        cmds.setParent("..")


    @staticmethod
    def updateContent(parent, selectedFilename):
        """ 
            Update the displayed content following the file selection 
            Note: If the file is not a render setup file or is a directory, 
                  the content (notes & preview) will be empty.
        """
        notesText       = ''
        previewText     = ''

        import os
        if os.path.isfile(selectedFilename):
            with open(selectedFilename, 'r') as file:
                try:
                    import json
                    dict = json.load(file)
                    if jsonTranslatorUtils.isRenderSetup(dict):
                        notesText   = jsonTranslatorUtils.getObjectNotes(dict)
                        previewText = json.dumps(dict, indent=2, sort_keys=True)
                    else:
                        notesText = kUnknownFile
                except:
                    notesText = kUnknownFile

        cmds.scrollField(ImportAllUI.notesEditor, edit=True, text=notesText)
        cmds.scrollField(ImportAllUI.previewEditor, edit=True, text=previewText)

    @staticmethod
    def setOverwriteImportType(data):
        """ 
            Completely overwrite the content of the existing render setup with the imported content.
        """
        ImportAllUI.colorType= jsonTranslatorGlobals.DECODE_AND_ADD
        cmds.textField(ImportAllUI.importTextEditor, edit=True, enable=False)

    @staticmethod
    def setLabelColorImport(value):
        """ 
            User can decide to import label colors from json 
        """
        ImportAllUI.importColorType = jsonTranslatorGlobals.ACCEPT_COLOR if value else jsonTranslatorGlobals.REJECT_COLOR
        jsonTranslatorGlobals.enableImportLabelColor(value)

    @staticmethod
    def setMergeImportType(data):
        """ 
            Merge the content of the existing render setup with the imported content. 
            If an unexpected render setup object is found it will renamed using the 'importText'.
        """
        ImportAllUI.importType = jsonTranslatorGlobals.DECODE_AND_MERGE
        cmds.textField(ImportAllUI.importTextEditor, edit=True, enable=False)

    @staticmethod
    def setRenameImportType(data):
        """ 
            Always rename the imported render setup content using the 'importText'.
        """
        ImportAllUI.importType = jsonTranslatorGlobals.DECODE_AND_RENAME
        cmds.textField(ImportAllUI.importTextEditor, edit=True, enable=True)

    @staticmethod
    def setImportText(data):
        """ 
            Preserve the text because it's consumed after the UI is gone.
        """
        ImportAllUI.importText = data


class ImportAOVsUI(object):
    """
        Helper class to build the Options UI for the fileDialog2 command used for importing AOVs
    """
    
    # What kind of import ?
    importType = jsonTranslatorGlobals.DECODE_AND_ADD

    @staticmethod
    def addOptions(parent):
        with ParentGuard():
            cmds.setParent(parent)
            cmds.frameLayout(label=kGeneralOptions, collapsable=True, marginWidth= DEFAULT_UI_INDENTATION)
            cmds.columnLayout(rowSpacing=10)
            cmds.radioCollection()
            cmds.radioButton(label=kOverwrite, 
                onCommand=ImportAOVsUI.setOverwriteImportType, select=True if ImportAOVsUI.importType==jsonTranslatorGlobals.DECODE_AND_ADD else False)
            cmds.text(label=kOverwriteExplanation, align='left')
            cmds.radioButton(label=kMerge, 
                onCommand=ImportAOVsUI.setMergeImportType, select=True if ImportAOVsUI.importType==jsonTranslatorGlobals.DECODE_AND_MERGE else False)
            cmds.text(label=kMergeAOVExplanation, align='left')
            cmds.setParent("..")
            cmds.setParent("..")

    @staticmethod
    def setOverwriteImportType(data):
        """ 
            Completely overwrite the content of the existing render setup with the imported content.
        """
        ImportAOVsUI.importType = jsonTranslatorGlobals.DECODE_AND_ADD

    @staticmethod
    def setMergeImportType(data):
        """ 
            Merge the content of the existing render setup with the imported content. 
            If an unexpected render setup object is found it will renamed using the 'importText'.
        """
        ImportAOVsUI.importType = jsonTranslatorGlobals.DECODE_AND_MERGE
# ===========================================================================
# Copyright 2018 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
