import maya
maya.utils.loadStringResourcesForModule(__name__)

import maya.mel as mel

import maya.api.OpenMaya as OpenMaya

import maya.app.renderSetup.common.utils as commonUtils

import maya.app.renderSetup.model.plug as plug
import maya.app.renderSetup.model.jsonTranslatorGlobals as jsonTranslatorGlobals

# List of callbacks types
CALLBACKS_TYPE_RENDER_SETTINGS = 0
CALLBACKS_TYPE_AOVS = 1

# Errors
kDefaultNodeMissing = maya.stringTable['y_rendererCallbacks.kDefaultNodeMissing' ]
kDefaultNodeAttrMissing = maya.stringTable['y_rendererCallbacks.kDefaultNodeAttrMissing' ]
kAttributesNotExportable = maya.stringTable['y_rendererCallbacks.kAttributesNotExportable' ]


class RenderSettingsCallbacks(object):
    '''Renderers should either extend this class or create a class with the same signature to provide additional render settings callbacks'''
    
    def encode(self):
        '''Encodes any renderer specific render settings data'''
        return {}
        
    def decode(self, rendererData):
        '''Decodes any renderer specific render settings data'''
        pass
    
    def getNodes(self):
        '''Returns the default render settings nodes for the specific renderer'''
        return []
        
    def createDefaultNodes(self):
        '''Create the default nodes for the specific renderer'''
        pass

class AOVCallbacks(object):
    '''Renderers should either extend this class or create a class with the same signature to provide additional AOV callbacks'''

    DECODE_TYPE_OVERWRITE = jsonTranslatorGlobals.DECODE_AND_ADD
    DECODE_TYPE_MERGE     = jsonTranslatorGlobals.DECODE_AND_MERGE

    @staticmethod
    def aovNodeTypes():
        '''Return the AOV node types supported by this renderer.'''
        return []

    def encode(self):
        '''Encodes the AOV information into some format'''
        return {}
     
    def decode(self, aovsData, decodeType):
        '''Decodes the AOV information from some format
        
        aovsData   - The AOV data to decode
        decodeType - Overwrite, Merge
        '''
        pass
    
    def displayMenu(self):
        '''Displays the AOV information for the current renderer'''
        pass

    def getAOVName(self, aovNode):
        '''From a given AOV node, returns the AOV name'''
        return ""
        
    def getCollectionSelector(self, selectorName):
        '''Creates the selector for the AOV collection'''
        return None

    def getChildCollectionSelector(self, selectorName, aovName):
        '''Creates the selector for the AOV child collection'''
        return None
    
    def getChildCollectionSelectorAOVNodeFromDict(self, d):
        '''Returns the child selector AOV node name from the provided dictionary'''
        return None

class NodeExporter(object):
    '''Helper exporter to encode/decode any nodes'''
    _plugsToIgnore = []

    def __init__(self):
        self._warnPlugsToIgnore = False

    def encode(self):

        if self._warnPlugsToIgnore and len(self._plugsToIgnore) > 0:
            OpenMaya.MGlobal.displayInfo(kAttributesNotExportable % ", ".join(self._plugsToIgnore))

        attrs = {}
        for name in self.getNodes():
            node = commonUtils.nameToNode(name)
            nodeFn = None
            try:
                nodeFn = OpenMaya.MFnDependencyNode(node)
            except:
                # No guarantee that the default node exist
                OpenMaya.MGlobal.displayWarning(kDefaultNodeMissing % name)
            else:
                for attrIdx in xrange(nodeFn.attributeCount()):
                    plg = plug.Plug(node, nodeFn.attribute(attrIdx))
                    if plg.type is not plug.Plug.kInvalid and plg.name not in self._plugsToIgnore:
                        attrs[plg.name] = plg.value
        return attrs

    def decode(self, encodedData):
        nodes = {} # Avoid creating several time the same node
        for (key, value) in encodedData.items():
            (nodeName, attrName) = plug.Plug.getNames(key)
            node = None
            if nodeName in nodes:
                node = nodes[nodeName]
            else:
                try:
                    node = commonUtils.nameToNode(nodeName)
                    OpenMaya.MFnDependencyNode(node)
                except:
                    node = None
                nodes[nodeName] = node

            if node is None:
                # No guarantee that the default node exist
                OpenMaya.MGlobal.displayWarning(kDefaultNodeMissing % nodeName)
            else:
                plg = plug.findPlug(nodeName, attrName)
                if plg is None:
                    OpenMaya.MGlobal.displayWarning(kDefaultNodeAttrMissing % (nodeName, attrName))
                else:
                    plg.value = value

    def setPlugsToIgnore(self, plugsToIgnore):
        self._plugsToIgnore = plugsToIgnore

    def warnPlugsToIgnore(self, value):
        self._warnPlugsToIgnore = value
                
class BasicNodeExporter(NodeExporter):
    '''Exporter that is used to export the nodes that have been set'''
    _nodes = []

    def setNodes(self, nodes):
        self._nodes = nodes

    def getNodes(self):
        return self._nodes


global rendererCallbacks
rendererCallbacks = {}
def registerCallbacks(renderer, callbacksType, callbacks):
    if not renderer in rendererCallbacks:
        rendererCallbacks[renderer] = dict()
    rendererCallbacks[renderer][callbacksType] = callbacks

def unregisterCallbacks(renderer, callbacksType=None):
    if renderer in rendererCallbacks:
        if callbacksType == None:
            del rendererCallbacks[renderer]
        elif callbacksType in rendererCallbacks[renderer]:
            del rendererCallbacks[renderer][callbacksType]

def getCallbacks(*args):
    if len(args) == 1:
        renderer =  mel.eval("currentRenderer()")
        callbacksType = args[0]
    else:
        renderer = args[0]
        callbacksType = args[1]
        
    return None if not renderer in rendererCallbacks or \
        not callbacksType in rendererCallbacks[renderer] \
        else rendererCallbacks[renderer][callbacksType]
# ===========================================================================
# Copyright 2018 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
