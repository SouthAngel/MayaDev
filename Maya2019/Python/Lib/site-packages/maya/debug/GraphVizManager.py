import maya
maya.utils.loadStringResourcesForModule(__name__)

'''
Classes managing the handling of DOT format files, including the external graphViz tool
'''

__all__ = [ 'GraphVizManager'
          ]

import os
import sys
import subprocess
import maya.cmds as cmds
from maya.debug.em_debug_utilities import convert_exception_to_unicode

#======================================================================
class GraphVizManager(object):
    '''Class to manage operations performed by the external graphViz tool'''
    def __init__(self, use_system_graphviz):
        '''Initialize the location of the graphviz command path for later use'''
        self.graphviz_path = ''
        if not use_system_graphviz:
            self.graphviz_path = os.environ.get('MAYA_GRAPHVIZ_PATH', '')
            if not self.graphviz_path:
                # MacOS distribution structure is slightly different.
                if cmds.about(macOS=True):
                    maya_path = os.path.dirname(sys.argv[0])
                    maya_bin_path = os.path.normpath(os.path.join(maya_path, '../bin'))
                else:
                    maya_bin_path = os.path.dirname(sys.argv[0])
                self.graphviz_path = os.path.join(maya_bin_path, 'graphviz')

    #----------------------------------------------------------------------
    def get_command(self, command_name):
        """
        Build a string for the Graphviz command to run.
        """
        return os.path.join(self.graphviz_path, command_name)

    #----------------------------------------------------------------------
    def get_version(self):
        """
        :return: output from the graphviz command "dot -V"
        """
        command_dot = [self.get_command('dot'), '-V']
        success, output = self.run_command(command_dot)
        return output[1] if success else None

    #----------------------------------------------------------------------
    @staticmethod
    def run_command(command_argv, stdin=None, stdout=None):
        """
        Run a Graphviz command and handle errors.
        """
        params = {'stderr': subprocess.PIPE, 'stdin': subprocess.PIPE, 'stdout': subprocess.PIPE}
        if stdin:
            params['stdin'] = stdin
        if stdout:
            params['stdout'] = stdout

        try:
            gv_process = subprocess.Popen(command_argv, **params)
            output = gv_process.communicate()
            return_code = gv_process.returncode

            # MEL error command raises an exception, so it has to be outside of the try/except block.
            if return_code:
                message = maya.stringTable['y_GraphVizManager.kErrorGraphvizExecution' ]
                raise RuntimeError( message.format( os.path.basename(command_argv[0]), return_code, output[1] ) )

        except Exception as ex:
            message = maya.stringTable['y_GraphVizManager.kErrorGraphviz' ]
            cmds.error(message.format(os.path.basename(command_argv[0]), command_argv[0], convert_exception_to_unicode(ex)))
            return False, None

        return True, output

    #----------------------------------------------------------------------
    def convert_dot_to_pdf(self, input_file_name, output_file_name, transitive_reduction):
        """
        Convert a DOT file to PDF using Graphviz.
        :param input_file_name: Name of file where the .dot file resides
        :param output_file_name: Name of file where the .pdf file should be generated
        """
        temp_file = None
        if transitive_reduction:
            (root, ext) = os.path.splitext(input_file_name)
            output_tred_file_name = root + '.tr' + ext
            command_tred = [self.get_command('tred')]

            with open(input_file_name, 'r') as input_file:
                with open(output_tred_file_name, 'w') as output_tred_file:
                    try:
                        if not self.run_command(command_tred, stdin=input_file, stdout=output_tred_file)[0]:
                            return False
                    except Exception:
                        return False

            # If everything went fine, replace input file to convert.
            if os.path.isfile( output_tred_file_name ):
                temp_file = output_tred_file_name

            if not os.path.isfile(output_tred_file_name) or os.path.getsize(output_tred_file_name) == 0:
                cmds.warning( maya.stringTable['y_GraphVizManager.kEmptyTredFile' ] )
            else:
                input_file_name = output_tred_file_name

        success = True
        try:
            command_dot = [self.get_command('dot'), '-Tpdf', input_file_name, '-o', output_file_name]
            if not self.run_command(command_dot)[0]:
                success = False
        except Exception:
            success = False
        finally:
            # Safely remove the intermediate file, if it was introduced
            if temp_file is not None:
                try:
                    os.remove( temp_file )
                except OSError:
                    pass

        return success


#======================================================================
class DotFormatManager(object):
    '''Class to manage interactions with the DOT graph visualization format'''
    def __init__(self):
        pass

# ===========================================================================
# Copyright 2018 Autodesk, Inc. All rights reserved.
#
# Use of this software is subject to the terms of the Autodesk license
# agreement provided at the time of installation or download, or which
# otherwise accompanies this software in either electronic or hard copy form.
# ===========================================================================
